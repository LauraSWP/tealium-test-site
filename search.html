<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search - Tealium Test Site</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Tealium Universal Data Object -->
    <script type="text/javascript">
        var utag_data = {
            "tealium_event": "page_view",
            "page_type": "search",
            "page_name": "Search - Tealium Test Site",
            "site_section": "search",
            "site_language": "en",
            "country_code": "US",
            "currency_code": "USD",
            "customer_type": "guest",
            "page_category": "search",
            "content_type": "search_page",
            "search_keyword": "",
            "search_results": "0",
            "cart_total_items": "0",
            "cart_total_value": "0.00",
            "user_id": "",
            "is_logged_in": "0",
            "has_newsletter_subscription": "0"
        };
    </script>

    <!-- Tealium Universal Tag -->
    <script type="text/javascript">
        (function(a,b,c,d) {
            a='//tags.tiqcdn.com/utag/success-laura-solanes/dog-food/qa/utag.js';
            b=document;c='script';d=b.createElement(c);d.src=a;
            d.type='text/java'+c;d.async=true;
            a=b.getElementsByTagName(c)[0];a.parentNode.insertBefore(d,a)
        })();
    </script>

    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <h2>üêï Tealium Test Site</h2>
            </div>
            <ul class="nav-menu">
                <li class="nav-item"><a href="index.html" class="nav-link">Home</a></li>
                <li class="nav-item"><a href="products.html" class="nav-link">Products</a></li>
                <li class="nav-item"><a href="search.html" class="nav-link active">Search</a></li>
                <li class="nav-item"><a href="cart.html" class="nav-link">Cart</a></li>
                <li class="nav-item"><a href="checkout.html" class="nav-link">Checkout</a></li>
                <li class="nav-item"><a href="login.html" class="nav-link">Login</a></li>
                <li class="nav-item"><a href="consent.html" class="nav-link">Consent</a></li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="search-container">
            <section class="page-header">
                <h1>Search Products</h1>
                <p>Test search tracking and result analytics</p>
            </section>

            <!-- Search Form -->
            <section class="search-form-section">
                <form class="search-form" onsubmit="performSearch(event)">
                    <div class="search-input-container">
                        <input 
                            type="text" 
                            id="search-input" 
                            class="search-input" 
                            placeholder="Search for products..." 
                            autocomplete="off"
                            oninput="handleSearchInput()"
                        >
                        <button type="submit" class="btn btn-primary search-btn">Search</button>
                    </div>
                    
                    <!-- Search Filters -->
                    <div class="search-filters">
                        <select id="category-filter">
                            <option value="">All Categories</option>
                            <option value="electronics">Electronics</option>
                            <option value="clothing">Clothing</option>
                            <option value="books">Books</option>
                        </select>
                        
                        <select id="sort-filter">
                            <option value="relevance">Sort by Relevance</option>
                            <option value="price_low">Price: Low to High</option>
                            <option value="price_high">Price: High to Low</option>
                            <option value="newest">Newest First</option>
                            <option value="rating">Highest Rated</option>
                        </select>
                        
                        <select id="price-range">
                            <option value="">Any Price</option>
                            <option value="0-25">$0 - $25</option>
                            <option value="25-50">$25 - $50</option>
                            <option value="50-100">$50 - $100</option>
                            <option value="100+">$100+</option>
                        </select>
                        
                        <button type="button" onclick="clearSearchFilters()" class="btn btn-secondary">Clear Filters</button>
                    </div>
                </form>

                <!-- Search Suggestions -->
                <div id="search-suggestions" class="search-suggestions" style="display: none;">
                    <h3>Search Suggestions</h3>
                    <div class="suggestions-list">
                        <span class="suggestion-item" onclick="selectSuggestion('smartphone')">smartphone</span>
                        <span class="suggestion-item" onclick="selectSuggestion('laptop')">laptop</span>
                        <span class="suggestion-item" onclick="selectSuggestion('shirt')">shirt</span>
                        <span class="suggestion-item" onclick="selectSuggestion('book')">book</span>
                        <span class="suggestion-item" onclick="selectSuggestion('headphones')">headphones</span>
                        <span class="suggestion-item" onclick="selectSuggestion('analytics')">analytics</span>
                    </div>
                </div>

                <!-- Popular Searches -->
                <div class="popular-searches">
                    <h3>Popular Searches</h3>
                    <div class="popular-items">
                        <span class="popular-item" onclick="selectSuggestion('tealium')">tealium</span>
                        <span class="popular-item" onclick="selectSuggestion('tracking')">tracking</span>
                        <span class="popular-item" onclick="selectSuggestion('premium')">premium</span>
                        <span class="popular-item" onclick="selectSuggestion('analytics guide')">analytics guide</span>
                        <span class="popular-item" onclick="selectSuggestion('electronics')">electronics</span>
                    </div>
                </div>
            </section>

            <!-- Search Results -->
            <section id="search-results-section" class="search-results" style="display: none;">
                <div class="results-header">
                    <h2 id="results-title">Search Results</h2>
                    <div class="results-info">
                        <span id="results-count">0 results</span>
                        <span id="search-time">Search time: 0ms</span>
                    </div>
                </div>
                
                <div id="search-results-container">
                    <!-- Results will be dynamically inserted here -->
                </div>

                <!-- Pagination -->
                <div id="pagination" class="pagination" style="display: none;">
                    <button onclick="changePage(-1)" class="btn btn-secondary">Previous</button>
                    <span id="page-info">Page 1 of 1</span>
                    <button onclick="changePage(1)" class="btn btn-secondary">Next</button>
                </div>
            </section>

            <!-- No Results -->
            <section id="no-results" class="no-results" style="display: none;">
                <h2>No Results Found</h2>
                <p>Sorry, we couldn't find any products matching your search.</p>
                <div class="suggestions">
                    <h3>Try these suggestions:</h3>
                    <ul>
                        <li>Check your spelling</li>
                        <li>Use different keywords</li>
                        <li>Try more general terms</li>
                        <li>Browse our <a href="products.html">product catalog</a></li>
                    </ul>
                </div>
            </section>

            <!-- Search Testing Controls -->
            <section class="testing-controls">
                <h2>Search Testing Controls</h2>
                <div class="testing-buttons">
                    <button onclick="testPreDefinedSearch('smartphone')" class="btn btn-secondary">Test: Search "smartphone"</button>
                    <button onclick="testPreDefinedSearch('analytics')" class="btn btn-secondary">Test: Search "analytics"</button>
                    <button onclick="testNoResultsSearch()" class="btn btn-secondary">Test: No Results Search</button>
                    <button onclick="testAutoComplete()" class="btn btn-secondary">Test: Auto Complete</button>
                    <button onclick="simulateSearchError()" class="btn btn-secondary">Test: Search Error</button>
                    <button onclick="clearSearchHistory()" class="btn btn-tertiary">Clear Search History</button>
                </div>
            </section>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 Tealium Test Site - Search</p>
            <div class="debug-info">
                <button onclick="showDebugInfo()" class="btn btn-small">Show Debug Info</button>
                <button onclick="showSearchHistory()" class="btn btn-small">Search History</button>
            </div>
        </div>
    </footer>

    <script src="tracking.js"></script>
    <script>
        // Search functionality and tracking
        
        const mockProducts = [
            {id: 'PHONE001', name: 'Premium Smartphone', price: 299.99, category: 'electronics', description: 'Latest smartphone with advanced features'},
            {id: 'SHIRT001', name: 'Tealium T-Shirt', price: 59.99, category: 'clothing', description: 'Comfortable branded t-shirt'},
            {id: 'BOOK001', name: 'Analytics Guide', price: 29.99, category: 'books', description: 'Comprehensive guide to analytics'},
            {id: 'LAPTOP001', name: 'Tracking Laptop', price: 899.99, category: 'electronics', description: 'High-performance laptop for tracking'},
            {id: 'SHOES001', name: 'Analytics Sneakers', price: 79.99, category: 'clothing', description: 'Comfortable sneakers for analytics sessions'},
            {id: 'AUDIO001', name: 'Data Headphones', price: 49.99, category: 'electronics', description: 'High-quality headphones for testing'}
        ];
        
        let currentPage = 1;
        let resultsPerPage = 3;
        let lastSearchResults = [];
        
        function performSearch(event) {
            if (event) {
                event.preventDefault();
            }
            
            const searchTerm = document.getElementById('search-input').value.trim();
            
            if (!searchTerm) {
                alert('Please enter a search term');
                return;
            }
            
            const startTime = performance.now();
            
            // Simulate search processing
            setTimeout(() => {
                const endTime = performance.now();
                const searchTime = Math.round(endTime - startTime);
                
                executeSearch(searchTerm, searchTime);
            }, Math.random() * 500 + 100); // Random delay between 100-600ms
        }
        
        function executeSearch(searchTerm, searchTime) {
            const categoryFilter = document.getElementById('category-filter').value;
            const sortFilter = document.getElementById('sort-filter').value;
            const priceRange = document.getElementById('price-range').value;
            
            // Filter products based on search term
            let results = mockProducts.filter(product => {
                const matchesSearch = product.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                    product.description.toLowerCase().includes(searchTerm.toLowerCase());
                const matchesCategory = !categoryFilter || product.category === categoryFilter;
                const matchesPrice = !priceRange || checkPriceRange(product.price, priceRange);
                
                return matchesSearch && matchesCategory && matchesPrice;
            });
            
            // Sort results
            results = sortResults(results, sortFilter);
            
            lastSearchResults = results;
            currentPage = 1;
            
            // Track search event
            trackSearchEvent(searchTerm, results.length, {
                category_filter: categoryFilter,
                sort_filter: sortFilter,
                price_range: priceRange,
                search_time: searchTime
            });
            
            // Update data layer
            updateSearchDataLayer(searchTerm, results.length);
            
            // Display results
            displaySearchResults(results, searchTerm, searchTime);
            
            // Save to search history
            saveSearchToHistory(searchTerm, results.length);
        }
        
        function trackSearchEvent(searchTerm, resultCount, filters) {
            if (window.TealiumTracker) {
                window.TealiumTracker.trackSearch(searchTerm, resultCount, filters);
            }
            
            console.log('Search tracked:', {
                search_keyword: searchTerm,
                search_results: resultCount,
                filters: filters
            });
        }
        
        function updateSearchDataLayer(searchTerm, resultCount) {
            if (window.utag_data) {
                window.utag_data.search_keyword = searchTerm;
                window.utag_data.search_results = resultCount.toString();
                window.utag_data.tealium_event = 'search';
            }
        }
        
        function displaySearchResults(results, searchTerm, searchTime) {
            const resultsSection = document.getElementById('search-results-section');
            const noResultsSection = document.getElementById('no-results');
            const resultsTitle = document.getElementById('results-title');
            const resultsCount = document.getElementById('results-count');
            const searchTimeElement = document.getElementById('search-time');
            const resultsContainer = document.getElementById('search-results-container');
            
            if (results.length === 0) {
                resultsSection.style.display = 'none';
                noResultsSection.style.display = 'block';
                
                // Track no results event
                if (window.TealiumTracker) {
                    window.TealiumTracker.trackCustomEvent('search_no_results', 'site_search', {
                        search_keyword: searchTerm,
                        search_filters_applied: getActiveFilters()
                    });
                }
                return;
            }
            
            noResultsSection.style.display = 'none';
            resultsSection.style.display = 'block';
            
            resultsTitle.textContent = `Results for "${searchTerm}"`;
            resultsCount.textContent = `${results.length} result${results.length !== 1 ? 's' : ''}`;
            searchTimeElement.textContent = `Search time: ${searchTime}ms`;
            
            // Paginate results
            const totalPages = Math.ceil(results.length / resultsPerPage);
            const startIndex = (currentPage - 1) * resultsPerPage;
            const endIndex = Math.min(startIndex + resultsPerPage, results.length);
            const pageResults = results.slice(startIndex, endIndex);
            
            // Display results
            resultsContainer.innerHTML = pageResults.map((product, index) => `
                <div class="search-result-item" onclick="selectSearchResult('${product.id}', '${product.name}', ${startIndex + index + 1})">
                    <div class="result-content">
                        <h3>${highlightSearchTerm(product.name, searchTerm)}</h3>
                        <p class="result-price">$${product.price}</p>
                        <p class="result-description">${highlightSearchTerm(product.description, searchTerm)}</p>
                        <p class="result-category">Category: ${product.category}</p>
                    </div>
                    <div class="result-actions">
                        <button onclick="viewProductFromSearch('${product.id}', '${product.name}', '${product.price}', '${product.category}', event)" class="btn btn-secondary">View</button>
                        <button onclick="addToCartFromSearch('${product.id}', '${product.name}', '${product.price}', event)" class="btn btn-primary">Add to Cart</button>
                    </div>
                </div>
            `).join('');
            
            // Update pagination
            updatePagination(totalPages);
        }
        
        function highlightSearchTerm(text, searchTerm) {
            if (!searchTerm) return text;
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            return text.replace(regex, '<mark>$1</mark>');
        }
        
        function updatePagination(totalPages) {
            const pagination = document.getElementById('pagination');
            const pageInfo = document.getElementById('page-info');
            
            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }
            
            pagination.style.display = 'flex';
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
        }
        
        function changePage(direction) {
            const totalPages = Math.ceil(lastSearchResults.length / resultsPerPage);
            const newPage = currentPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                const searchTerm = document.getElementById('search-input').value;
                displaySearchResults(lastSearchResults, searchTerm, 0);
                
                // Track pagination
                if (window.TealiumTracker) {
                    window.TealiumTracker.trackCustomEvent('search_pagination', 'site_search', {
                        page_number: currentPage.toString(),
                        total_pages: totalPages.toString(),
                        direction: direction > 0 ? 'next' : 'previous'
                    });
                }
            }
        }
        
        function selectSearchResult(productId, productName, position) {
            // Track search result click
            if (window.TealiumTracker) {
                window.TealiumTracker.trackCustomEvent('search_result_click', 'site_search', {
                    product_id: productId,
                    product_name: productName,
                    search_keyword: document.getElementById('search-input').value,
                    result_position: position.toString(),
                    page_number: currentPage.toString()
                });
            }
        }
        
        function viewProductFromSearch(productId, productName, price, category, event) {
            event.stopPropagation();
            
            // Track product view from search
            if (window.TealiumTracker) {
                window.TealiumTracker.trackCustomEvent('product_view_from_search', 'ecommerce', {
                    product_id: productId,
                    product_name: productName,
                    search_keyword: document.getElementById('search-input').value,
                    traffic_source: 'search_results'
                });
            }
            
            alert(`Viewing ${productName} from search results - Event tracked!`);
        }
        
        function addToCartFromSearch(productId, productName, price, event) {
            event.stopPropagation();
            
            // Add to cart logic (simplified)
            if (window.TealiumTracker) {
                window.TealiumTracker.trackAddToCart(productId, productName, price, 1);
            }
            
            alert(`${productName} added to cart from search results!`);
        }
        
        // Search input handling
        function handleSearchInput() {
            const searchTerm = document.getElementById('search-input').value;
            const suggestions = document.getElementById('search-suggestions');
            
            if (searchTerm.length >= 2) {
                suggestions.style.display = 'block';
                
                // Track search input (debounced)
                clearTimeout(window.searchInputTimeout);
                window.searchInputTimeout = setTimeout(() => {
                    if (window.TealiumTracker) {
                        window.TealiumTracker.trackCustomEvent('search_input', 'site_search', {
                            search_term_partial: searchTerm,
                            input_length: searchTerm.length.toString()
                        });
                    }
                }, 500);
            } else {
                suggestions.style.display = 'none';
            }
        }
        
        function selectSuggestion(suggestion) {
            document.getElementById('search-input').value = suggestion;
            document.getElementById('search-suggestions').style.display = 'none';
            
            // Track suggestion selection
            if (window.TealiumTracker) {
                window.TealiumTracker.trackCustomEvent('search_suggestion_click', 'site_search', {
                    selected_suggestion: suggestion,
                    suggestion_type: 'auto_suggest'
                });
            }
            
            performSearch();
        }
        
        // Utility functions
        function checkPriceRange(price, range) {
            if (!range) return true;
            
            if (range === '0-25') return price <= 25;
            if (range === '25-50') return price > 25 && price <= 50;
            if (range === '50-100') return price > 50 && price <= 100;
            if (range === '100+') return price > 100;
            
            return true;
        }
        
        function sortResults(results, sortBy) {
            switch (sortBy) {
                case 'price_low':
                    return results.sort((a, b) => a.price - b.price);
                case 'price_high':
                    return results.sort((a, b) => b.price - a.price);
                case 'newest':
                    return results.sort((a, b) => b.id.localeCompare(a.id));
                case 'rating':
                    return results.sort(() => Math.random() - 0.5); // Random for demo
                default:
                    return results;
            }
        }
        
        function getActiveFilters() {
            const filters = {};
            const category = document.getElementById('category-filter').value;
            const sort = document.getElementById('sort-filter').value;
            const price = document.getElementById('price-range').value;
            
            if (category) filters.category = category;
            if (sort !== 'relevance') filters.sort = sort;
            if (price) filters.price = price;
            
            return JSON.stringify(filters);
        }
        
        function clearSearchFilters() {
            document.getElementById('category-filter').value = '';
            document.getElementById('sort-filter').value = 'relevance';
            document.getElementById('price-range').value = '';
            
            // Track filter clear
            if (window.TealiumTracker) {
                window.TealiumTracker.trackCustomEvent('search_filter_clear', 'site_search', {});
            }
            
            // Re-run search if there's a current search term
            const searchTerm = document.getElementById('search-input').value;
            if (searchTerm) {
                performSearch();
            }
        }
        
        function saveSearchToHistory(searchTerm, resultCount) {
            let history = JSON.parse(localStorage.getItem('search_history') || '[]');
            
            // Remove existing entry
            history = history.filter(item => item.term !== searchTerm);
            
            // Add to beginning
            history.unshift({
                term: searchTerm,
                results: resultCount,
                timestamp: new Date().toISOString()
            });
            
            // Keep only last 10
            history = history.slice(0, 10);
            
            localStorage.setItem('search_history', JSON.stringify(history));
        }
        
        // Testing functions
        function testPreDefinedSearch(term) {
            document.getElementById('search-input').value = term;
            performSearch();
        }
        
        function testNoResultsSearch() {
            document.getElementById('search-input').value = 'xyznoresults123';
            performSearch();
        }
        
        function testAutoComplete() {
            document.getElementById('search-input').value = 'sma';
            handleSearchInput();
            alert('Auto-complete suggestions shown - check console for tracking events');
        }
        
        function simulateSearchError() {
            if (window.TealiumTracker) {
                window.TealiumTracker.trackCustomEvent('search_error', 'error', {
                    error_type: 'search_timeout',
                    search_keyword: document.getElementById('search-input').value || 'test_error',
                    error_message: 'Search request timed out'
                });
            }
            alert('Search error simulated - Event tracked!');
        }
        
        function clearSearchHistory() {
            localStorage.removeItem('search_history');
            alert('Search history cleared!');
        }
        
        function showSearchHistory() {
            const history = JSON.parse(localStorage.getItem('search_history') || '[]');
            alert('Search History:\n' + JSON.stringify(history, null, 2));
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Hide suggestions when clicking outside
            document.addEventListener('click', function(event) {
                const suggestions = document.getElementById('search-suggestions');
                const searchInput = document.getElementById('search-input');
                
                if (!suggestions.contains(event.target) && event.target !== searchInput) {
                    suggestions.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html> 